const express = require("express");
const fs = require("fs").promises; // Importando fs com suporte a Promises
const path = require("path");

// Inicialização do Express
const app = express();
const PORT = process.env.PORT || 8080;
const dbFilePath = path.resolve(__dirname, "db.json"); // Caminho completo para db.json

// Middleware para processar JSON no corpo das requisições
app.use(express.json());

// Middleware para processar JSON no corpo das requisições
app.use(express.json());

// Middleware para adicionar cabeçalhos CORS
app.use((req, res, next) => {
  res.setHeader("Access-Control-Allow-Origin", "*"); // Permite qualquer origem
  res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
  next();
});

// Função para extrair o país do cabeçalho 'Accept-Language'
function extractCountryFromHeaders(headers) {
  const acceptLanguageHeader = headers["accept-language"];
  if (!acceptLanguageHeader) return null;

  // Lista de códigos de país válidos (https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2)
  const validCountryCodes = [
    "AA",
    "AB",
    "AC",
    "AD",
    "AE",
    "AF",
    "AG",
    "AH",
    "AI",
    "AJ",
    "AK",
    "AL",
    "AM",
    "AN",
    "AO",
    "AP",
    "AQ",
    "AR",
    "AS",
    "AT",
    "AU",
    "AV",
    "AW",
    "AX",
    "AY",
    "AZ",
    "BA",
    "BB",
    "BC",
    "BD",
    "BE",
    "BF",
    "BG",
    "BH",
    "BI",
    "BJ",
    "BK",
    "BL",
    "BM",
    "BN",
    "BO",
    "BP",
    "BQ",
    "BR",
    "BS",
    "BT",
    "BU",
    "BV",
    "BW",
    "BX",
    "BY",
    "BZ",
    "CA",
    "CB",
    "CC",
    "CD",
    "CE",
    "CF",
    "CG",
    "CH",
    "CI",
    "CJ",
    "CK",
    "CL",
    "CM",
    "CN",
    "CO",
    "CP",
    "CQ",
    "CR",
    "CS",
    "CT",
    "CU",
    "CV",
    "CW",
    "CX",
    "CY",
    "CZ",
    "DA",
    "DB",
    "DC",
    "DD",
    "DE",
    "DF",
    "DG",
    "DH",
    "DI",
    "DJ",
    "DK",
    "DL",
    "DM",
    "DN",
    "DO",
    "DP",
    "DQ",
    "DR",
    "DS",
    "DT",
    "DU",
    "DV",
    "DW",
    "DX",
    "DY",
    "DZ",
    "EA",
    "EB",
    "EC",
    "ED",
    "EE",
    "EF",
    "EG",
    "EH",
    "EI",
    "EJ",
    "EK",
    "EL",
    "EM",
    "EN",
    "EO",
    "EP",
    "EQ",
    "ER",
    "ES",
    "ET",
    "EU",
    "EV",
    "EW",
    "EX",
    "EY",
    "EZ",
    "FA",
    "FB",
    "FC",
    "FD",
    "FE",
    "FF",
    "FG",
    "FH",
    "FI",
    "FJ",
    "FK",
    "FL",
    "FM",
    "FN",
    "FO",
    "FP",
    "FQ",
    "FR",
    "FS",
    "FT",
    "FU",
    "FV",
    "FW",
    "FX",
    "FY",
    "FZ",
    "GA",
    "GB",
    "GC",
    "GD",
    "GE",
    "GF",
    "GG",
    "GH",
    "GI",
    "GJ",
    "GK",
    "GL",
    "GM",
    "GN",
    "GO",
    "GP",
    "GQ",
    "GR",
    "GS",
    "GT",
    "GU",
    "GV",
    "GW",
    "GX",
    "GY",
    "GZ",
    "HA",
    "HB",
    "HC",
    "HD",
    "HE",
    "HF",
    "HG",
    "HH",
    "HI",
    "HJ",
    "HK",
    "HL",
    "HM",
    "HN",
    "HO",
    "HP",
    "HQ",
    "HR",
    "HS",
    "HT",
    "HU",
    "HV",
    "HW",
    "HX",
    "HY",
    "HZ",
    "IA",
    "IB",
    "IC",
    "ID",
    "IE",
    "IF",
    "IG",
    "IH",
    "II",
    "IJ",
    "IK",
    "IL",
    "IM",
    "IN",
    "IO",
    "IP",
    "IQ",
    "IR",
    "IS",
    "IT",
    "IU",
    "IV",
    "IW",
    "IX",
    "IY",
    "IZ",
    "JA",
    "JB",
    "JC",
    "JD",
    "JE",
    "JF",
    "JG",
    "JH",
    "JI",
    "JJ",
    "JK",
    "JL",
    "JM",
    "JN",
    "JO",
    "JP",
    "JQ",
    "JR",
    "JS",
    "JT",
    "JU",
    "JV",
    "JW",
    "JX",
    "JY",
    "JZ",
    "KA",
    "KB",
    "KC",
    "KD",
    "KE",
    "KF",
    "KG",
    "KH",
    "KI",
    "KJ",
    "KK",
    "KL",
    "KM",
    "KN",
    "KO",
    "KP",
    "KQ",
    "KR",
    "KS",
    "KT",
    "KU",
    "KV",
    "KW",
    "KX",
    "KY",
    "KZ",
    "LA",
    "LB",
    "LC",
    "LD",
    "LE",
    "LF",
    "LG",
    "LH",
    "LI",
    "LJ",
    "LK",
    "LL",
    "LM",
    "LN",
    "LO",
    "LP",
    "LQ",
    "LR",
    "LS",
    "LT",
    "LU",
    "LV",
    "LW",
    "LX",
    "LY",
    "LZ",
    "MA",
    "MB",
    "MC",
    "MD",
    "ME",
    "MF",
    "MG",
    "MH",
    "MI",
    "MJ",
    "MK",
    "ML",
    "MM",
    "MN",
    "MO",
    "MP",
    "MQ",
    "MR",
    "MS",
    "MT",
    "MU",
    "MV",
    "MW",
    "MX",
    "MY",
    "MZ",
    "NA",
    "NB",
    "NC",
    "ND",
    "NE",
    "NF",
    "NG",
    "NH",
    "NI",
    "NJ",
    "NK",
    "NL",
    "NM",
    "NN",
    "NO",
    "NP",
    "NQ",
    "NR",
    "NS",
    "NT",
    "NU",
    "NV",
    "NW",
    "NX",
    "NY",
    "NZ",
    "OA",
    "OB",
    "OC",
    "OD",
    "OE",
    "OF",
    "OG",
    "OH",
    "OI",
    "OJ",
    "OK",
    "OL",
    "OM",
    "ON",
    "OO",
    "OP",
    "OQ",
    "OR",
    "OS",
    "OT",
    "OU",
    "OV",
    "OW",
    "OX",
    "OY",
    "OZ",
    "PA",
    "PB",
    "PC",
    "PD",
    "PE",
    "PF",
    "PG",
    "PH",
    "PI",
    "PJ",
    "PK",
    "PL",
    "PM",
    "PN",
    "PO",
    "PP",
    "PQ",
    "PR",
    "PS",
    "PT",
    "PU",
    "PV",
    "PW",
    "PX",
    "PY",
    "PZ",
    "QA",
    "QB",
    "QC",
    "QD",
    "QE",
    "QF",
    "QG",
    "QH",
    "QI",
    "QJ",
    "QK",
    "QL",
    "QM",
    "QN",
    "QO",
    "QP",
    "QQ",
    "QR",
    "QS",
    "QT",
    "QU",
    "QV",
    "QW",
    "QX",
    "QY",
    "QZ",
    "RA",
    "RB",
    "RC",
    "RD",
    "RE",
    "RF",
    "RG",
    "RH",
    "RI",
    "RJ",
    "RK",
    "RL",
    "RM",
    "RN",
    "RO",
    "RP",
    "RQ",
    "RR",
    "RS",
    "RT",
    "RU",
    "RV",
    "RW",
    "RX",
    "RY",
    "RZ",
    "SA",
    "SB",
    "SC",
    "SD",
    "SE",
    "SF",
    "SG",
    "SH",
    "SI",
    "SJ",
    "SK",
    "SL",
    "SM",
    "SN",
    "SO",
    "SP",
    "SQ",
    "SR",
    "SS",
    "ST",
    "SU",
    "SV",
    "SW",
    "SX",
    "SY",
    "SZ",
    "TA",
    "TB",
    "TC",
    "TD",
    "TE",
    "TF",
    "TG",
    "TH",
    "TI",
    "TJ",
    "TK",
    "TL",
    "TM",
    "TN",
    "TO",
    "TP",
    "TQ",
    "TR",
    "TS",
    "TT",
    "TU",
    "TV",
    "TW",
    "TX",
    "TY",
    "TZ",
    "UA",
    "UB",
    "UC",
    "UD",
    "UE",
    "UF",
    "UG",
    "UH",
    "UI",
    "UJ",
    "UK",
    "UL",
    "UM",
    "UN",
    "UO",
    "UP",
    "UQ",
    "UR",
    "US",
    "UT",
    "UU",
    "UV",
    "UW",
    "UX",
    "UY",
    "UZ",
    "VA",
    "VB",
    "VC",
    "VD",
    "VE",
    "VF",
    "VG",
    "VH",
    "VI",
    "VJ",
    "VK",
    "VL",
    "VM",
    "VN",
    "VO",
    "VP",
    "VQ",
    "VR",
    "VS",
    "VT",
    "VU",
    "VV",
    "VW",
    "VX",
    "VY",
    "VZ",
    "WA",
    "WB",
    "WC",
    "WD",
    "WE",
    "WF",
    "WG",
    "WH",
    "WI",
    "WJ",
    "WK",
    "WL",
    "WM",
    "WN",
    "WO",
    "WP",
    "WQ",
    "WR",
    "WS",
    "WT",
    "WU",
    "WV",
    "WW",
    "WX",
    "WY",
    "WZ",
    "XA",
    "XB",
    "XC",
    "XD",
    "XE",
    "XF",
    "XG",
    "XH",
    "XI",
    "XJ",
    "XK",
    "XL",
    "XM",
    "XN",
    "XO",
    "XP",
    "XQ",
    "XR",
    "XS",
    "XT",
    "XU",
    "XV",
    "XW",
    "XX",
    "XY",
    "XZ",
    "YA",
    "YB",
    "YC",
    "YD",
    "YE",
    "YF",
    "YG",
    "YH",
    "YI",
    "YJ",
    "YK",
    "YL",
    "YM",
    "YN",
    "YO",
    "YP",
    "YQ",
    "YR",
    "YS",
    "YT",
    "YU",
    "YV",
    "YW",
    "YX",
    "YY",
    "YZ",
    "ZA",
    "ZB",
    "ZC",
    "ZD",
    "ZE",
    "ZF",
    "ZG",
    "ZH",
    "ZI",
    "ZJ",
    "ZK",
    "ZL",
    "ZM",
    "ZN",
    "ZO",
    "ZP",
    "ZQ",
    "ZR",
    "ZS",
    "ZT",
    "ZU",
    "ZV",
    "ZW",
    "ZX",
    "ZY",
    "ZZ",
  ];
// Exemplo: 'en-US,en;q=0.9,pt-BR;q=0.8'
const languages = acceptLanguageHeader.split(",");
for (let language of languages) {
  // Exemplo: 'en-US' ou 'pt-BR'
  const languageParts = language.split(";")[0].trim(); // Remove a parte opcional ';q=...'
  const countryCode = languageParts.split("-")[1]; // Captura a parte do código do país

  // Verifica se o código do país é válido
  if (countryCode && validCountryCodes.includes(countryCode.toUpperCase())) {
    return countryCode.toUpperCase(); // Retorna o código do país em maiúsculas
  }
}
return null;
}

// Rota para receber o país do cliente e cadastrar número de celular
app.get("/pushnotification/:number_whatsapp", async (req, res) => {
const { number_whatsapp } = req.params;
const country = extractCountryFromHeaders(req.headers); // Captura o país do cabeçalho 'Accept-Language'

if (!country) {
  return res.status(400).send("País não encontrado nos headers da requisição");
}

try {
  // Lê o arquivo db.json
  const data = await fs.readFile(dbFilePath, "utf-8");
  let db = JSON.parse(data);

  // Verifica se já existe o número no banco de dados para o país especificado
  const existingNotification = db.notifications.find(
    (notification) =>
      notification.country === country &&
      notification.number_whatsapp === number_whatsapp
  );

  if (existingNotification) {
    return res.json({ message: "Número já cadastrado", exists: true });
  }

  // Gera um novo ID (pode ser feito com timestamp para simplificar)
  const id = Date.now().toString();

  // Adiciona nova notificação ao banco de dados
  const newNotification = { id, country, number_whatsapp };
  db.notifications.push(newNotification);

  // Escreve de volta no arquivo db.json
  await fs.writeFile(dbFilePath, JSON.stringify(db, null, 2));

  res.json({ message: "Número cadastrado com sucesso", exists: false });
} catch (error) {
  console.error("Erro ao processar requisição:", error);
  res.status(500).send("Erro interno ao processar a requisição");
}
});

// Iniciar o servidor
app.listen(PORT, () => {
console.log(`Servidor iniciado na porta ${PORT}`);
});